#!/bin/sh
#
#
# Manage MDSplus rpm packaging
#
# Usage: pkg mode options
#        mode == add remove list
#
# Modes:
#
# add: Add module to a rpm subpackage
#
#   Usage:    pkg add module-name package-name [-R]
#   examples: pkg add TreeAddNode.c kernel
#             pkg add treeshr/* kernel
#
# remove: Remove module from an rpm subpackage
#
#   Usage:    pkg remove module-name package-name [-R]
#   examples: pkg remove TreeAddNode.c kernel
#             pkg remove treeshr/* kernel
#
# list:   List modules in an rpm subpackage
#
#   Usage:    pkg list package-name
#   examples: pkg list kernel
#             pkg list NONE  (lists all modules not in any package)
#             pkg list ALL   (lists all modules and the package(s) they are in)
case $1 in
  add)
    if [ ! -r `dirname $0`/../rpm/subpackages/$3 -a "$3" != "ignore" ]
    then
      echo Package $3 does not exist
      exit
    fi
    for mod in `find $2`
    do
      pushd `dirname $mod` >/dev/null
      m=$(basename $mod)
      if [ ! -d $m ]
      then
        if ( cvs status $m 2>/dev/null | grep /mdsplus/repos > /dev/null )
        then
          echo "Adding `pwd`/$m to package $3"
          cvs -Q tag -F pkg_$3 $m
        fi
      fi
      popd > /dev/null
    done
  ;;
  remove)
    if [ ! -r `dirname $0`/../rpm/subpackages/$3 ]
    then
      echo Package $3 does not exist
      exit
    fi
    for mod in `find $2`
    do
      pushd `dirname $mod` >/dev/null
      m=$(basename $mod)
      if [ ! -d $m ]
      then
        if ( cvs status $m 2>/dev/null | grep -v Attic | grep /mdsplus/repos > /dev/null )
        then
          echo "Removing `pwd`/$m from package $3"
          cvs -Q tag -d pkg_$3 $m
        fi
      fi
      popd > /dev/null
    done
  ;;
  list)
    case $2 in
    NONE)
       dirn=$(dirname $0)
       cd $dirn/..
       for mod in `find .`
       do
	 pushd `dirname $mod` > /dev/null
	 m=$(basename $mod)
	 if [ ! -d $m ]
	 then
	   tmpfile=$(mktemp)
	   cvs status -v $m > $tmpfile 2>/dev/null
           if ( grep -v Attic $tmpfile | grep /mdsplus/repos > /dev/null && ! grep "pkg_" $tmpfile >/dev/null 2>&1 )
           then
             echo $mod not in any package
           fi
           rm -f $tmpfile
         fi
	 popd > /dev/null
       done
    ;;
    "")
       dirn=$(dirname $0)
       cd $dirn/..
       echo "<table><tr><td><b>Module</b></td><td><b>Package(s)</b></td></tr>"
       for mod in `find . -depth -type f`
       do
	 pushd `dirname $mod` > /dev/null
	 m=$(basename $mod)
         tmpfile=$(mktemp)
         cvs status -v $m > $tmpfile 2>/dev/null
         if ( grep -v Attic $tmpfile | grep /mdsplus/repos > /dev/null)
         then
           packages=$(grep "pkg_" $tmpfile 2>&1 | awk '{print substr($1,5)}')
           if [ -z "$packages" ]
           then
             echo "<tr><td>$mod</td><td>NONE</td></tr>"
           else
             echo "<tr><td>$mod</td><td>$packages</td></tr>"
           fi
         fi
         rm -f $tmpfile
	 popd > /dev/null
       done
    ;;
    *)
       dirn=$(dirname $0)
       cd $dirn/..
       for mod in `find . -depth -type f`
       do
	 pushd `dirname $mod` > /dev/null
	 m=$(basename $mod)
         tmpfile=$(mktemp)
         cvs status -v $m > $tmpfile 2>/dev/null
         if ( grep -v Attic $tmpfile | grep /mdsplus/repos > /dev/null && grep "pkg_"${2} $tmpfile >/dev/null 2>&1 )
         then
           echo $mod $2
         fi
         rm -f $tmpfile
	 popd > /dev/null
       done
    ;;
    esac
  ;;
  *)
     echo "Unknown mode. Usage 'pkg mode options' where mode==add,remove or list"
  ;;
esac
