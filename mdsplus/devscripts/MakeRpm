#!/bin/sh
#
if [ -z $1 ]
then
  if [ -r rpm/`uname -p`.spec ]
  then
    SPEC=`uname -p`
  else
    SPEC="rpm"
  fi
else
  SPEC="${1}"
fi
tag=`devscripts/GetRelease`
version=`devscripts/GetRelease version $tag`
release=`devscripts/GetRelease release $tag`
if (test "$XIO" = "")
then
    if (test "$GLOBUS_LOCATION" = "")
	then
	globuskit=
	enableglobus=
    else
	globuskit=-globus
	enableglobus=--enable-globus
    fi
else
    globuskit=-xio
    enableglobus=--with-xio=$GLOBUS_LOCATION\:$GLOBUS_FLAVOR
fi
mkdir mdskit$globuskit
cd mdskit$globuskit
cvs -d :pserver:`whoami`@www.mdsplus.org:/mdsplus/repos -Q checkout -r $tag mdsplus
mv mdsplus mdsplus$globuskit-$version
find . -name CVS -exec rm -Rf {} \; > /dev/null 2> /dev/null
tar zcf $HOME/rpm/SOURCES/mdsplus$globuskit-$version.tar.gz --exclude CVS mdsplus$globuskit-$version 
echo "s/#GLOBUS#/$globuskit/g" > tmp.sed
echo "s+#ENABLEGLOBUS#+$enableglobus+g" >> tmp.sed
echo "s/#VERSION#/$version/g" >> tmp.sed
echo "s/#RELEASE#/$release/g" >> tmp.sed
cat tmp.sed
sed -f tmp.sed mdsplus${globuskit}-${version}/rpm/${SPEC}.spec > rpm.spec 
rpmbuild -ba rpm.spec
cd ..
rm -Rf mdskit$globuskit
