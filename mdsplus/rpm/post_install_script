#!/bin/sh
if ( test "$RPM_INSTALL_PREFIX" != "")
then
  MDSPLUS_DIR=$RPM_INSTALL_PREFIX
else
  MDSPLUS_DIR=/usr/local
fi
until ( test -r $MDSPLUS_DIR/mdsplus/bin/tditest )
do
  echo -n "Enter the directory containing the mdsplus directory [$MDSPLUS_DIR]: "
  read MDSPLUS_DIR
done
echo $MDSPLUS_DIR > /etc/.mdsplus_dir
case "`uname`" in
Linux*)
#
# Linux post install script
#
# Add $MDSPLUS_DIR/mdsplus/lib to /etc/ld.so.conf
#
echo Configuring mdsplus libraries
if grep "^$MDSPLUS_DIR/mdsplus/lib" /etc/ld.so.conf > /dev/null
then
	true
else
	echo "$MDSPLUS_DIR/mdsplus/lib" >> /etc/ld.so.conf
fi
/sbin/ldconfig
#
# Add $MDSPLUS_DIR/mdsplus/man to manpath
#
echo Configuring mdsplus man pages
if grep "^MANPATH $MDSPLUS_DIR/mdsplus/man" /etc/man.config > /dev/null
then
	true
else
	echo "MANPATH $MDSPLUS_DIR/mdsplus/man" >> /etc/man.config
fi
#
# Add mdsip to services
#
echo Adding mdsip MDSplus data server
if grep "^mdsip " /etc/services >/dev/null
then
        true
else
        echo "mdsip    8000/tcp # Added by package mdsplus" >> /etc/services
fi
#
# Add mdsipd to inetd.conf
#
mkdirhier /var/log/mdsplus/mdsipd
if grep "^mdsip " /etc/inetd.conf > /dev/null
then
  true
else
  echo "mdsip stream	tcp	nowait root $MDSPLUS_DIR/mdsplus/bin/mdsipd mdsipd mdsip /var/log/mdsplus/mdsipd" >> /etc/inetd.conf
  kill -HUP `/sbin/pidof inetd`
fi
echo Adding MDSplus login scripts
ln -s $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.* /etc/profile.d/
echo Creating sample /etc/mdsip.hosts file for mdsip server to user mapping
if [ ! -r /etc/mdsip.hosts ]; then
  cp $MDSPLUS_DIR/mdsplus/etc/mdsip.hosts /etc/
fi
;;
OSF1*)
#
# Compaq TruUNIX post install script
#
# Put symlinks in /usr/local/lib to all MDSplus shared libraries
#
echo Configuring mdsplus libraries
ln -sf $MDSPLUS_DIR/mdsplus/lib/*.so /usr/local/lib
#
# Put symlinks in /usr/local/man to all MDSplus man pages
#
echo Configuring mdsplus man pages
if [ ! -r /usr/local/man ]; then
mkdir /usr/local/man
mkdir /usr/local/man/man1
mkdir /usr/local/man/man5
mkdir /usr/local/man/man8
chmod -R 755 /usr/local/man
else
if [ ! -r /usr/local/man/man1 ]; then
mkdir /usr/local/man/man1
chmod 755 /usr/local/man/man1
fi
if [ ! -r /usr/local/man/man5 ]; then
mkdir /usr/local/man/man5
chmod 755 /usr/local/man/man5
fi
if [ ! -r /usr/local/man/man8 ]; then
mkdir /usr/local/man/man8
chmod 755 /usr/local/man/man8
fi
fi
ln -sf $MDSPLUS_DIR/mdsplus/man/man1/*.gz /usr/local/man/man1
ln -sf $MDSPLUS_DIR/mdsplus/man/man5/*.gz /usr/local/man/man5
ln -sf $MDSPLUS_DIR/mdsplus/man/man8/*.gz /usr/local/man/man8
#
# Add mdsip to services
#
echo Adding mdsip MDSplus data server
if grep "^mdsip " /etc/services >/dev/null
then
        true
else
        echo "mdsip    8000/tcp # Added by package mdsplus" >> /etc/services
fi
#
# Add mdsipd to inetd.conf
#
/usr/bin/X11/mkdirhier /var/log/mdsplus/mdsipd
if grep "^mdsip " /etc/inetd.conf > /dev/null
then
  true
else
  echo "mdsip stream	tcp	nowait root $MDSPLUS_DIR/mdsplus/bin/mdsipd mdsipd mdsip /var/log/mdsplus/mdsipd" >> /etc/inetd.conf
  kill -HUP `/bin/ps -e -o pid -o command | /bin/grep /usr/sbin/inetd | /bin/grep -v grep | /bin/awk '{print $1}'`
fi
echo Adding MDSplus login scripts
if grep "^. $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.sh" /etc/profile > /dev/null
then
  true
else
  echo ". $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.sh" >> /etc/profile
fi
if grep "^source $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.csh" /etc/csh.login > /dev/null
then
  true
else
  echo "source $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.csh" >> /etc/csh.login
fi
echo Creating sample /etc/mdsip.hosts file for mdsip server to user mapping
if [ ! -r /etc/mdsip.hosts ]; then 
  cp $MDSPLUS_DIR/mdsplus/etc/mdsip.hosts /etc/ 
fi
;;
HP-UX*)
#
# HP-UX post install script
#
# Put symlinks in /usr/local/lib to all MDSplus shared libraries
#
echo Configuring mdsplus libraries
ln -sf $MDSPLUS_DIR/mdsplus/lib/*.sl /usr/local/lib
#
# Add $MDSPLUS_DIR/mdsplus/man to /etc/MANPATH
#
echo Configuring mdsplus man pages
if [ -r /etc/MANPATH ]; then
mv /etc/MANPATH /etc/MANPATH_pre_mdsplus
echo `cat /etc/MANPATH_pre_mdsplus`:$MDSPLUS_DIR/mdsplus/man > /etc/MANPATH
else
echo /usr/share/man:/usr/contrib/man:/usr/local/man:$MDSPLUS_DIR/mdsplus/man > /etc/MANPATH
fi
chmod 444 /etc/MANPATH
#
# Add mdsip to services
#
echo Adding mdsip MDSplus data server
if grep "^mdsip " /etc/services >/dev/null
then
        true
else
        echo "mdsip    8000/tcp # Added by package mdsplus" >> /etc/services
fi
#
# Add mdsipd to inetd.conf
#
/usr/bin/X11/mkdirhier /var/log/mdsplus/mdsipd
if grep "^mdsip " /etc/inetd.conf > /dev/null
then
  true
else
  echo "mdsip stream	tcp	nowait root $MDSPLUS_DIR/mdsplus/bin/mdsipd mdsipd mdsip /var/log/mdsplus/mdsipd" >> /etc/inetd.conf
  kill -HUP `/bin/ps -e | /bin/grep inetd | /bin/grep -v grep | /bin/awk '{print $1}'`
fi
echo Adding MDSplus login scripts
if grep "^. $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.sh" /etc/profile > /dev/null
then
  true
else
  echo ". $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.sh" >> /etc/profile
fi
if grep "^source $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.csh" /etc/csh.login > /dev/null
then
  true
else
  echo "source $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.csh" >> /etc/csh.login
fi
echo Creating sample /etc/mdsip.hosts file for mdsip server to user mapping
if [ ! -r /etc/mdsip.hosts ]; then 
  cp $MDSPLUS_DIR/mdsplus/etc/mdsip.hosts /etc/ 
fi
;;
SunOS*)
#
# SunOS post install script
#
# Put symlinks in /usr/local/lib to all MDSplus shared libraries
#
echo Configuring mdsplus libraries
ln -sf $MDSPLUS_DIR/mdsplus/lib/*.so /usr/local/lib
#
# Put symlinks in /usr/local/man to all MDSplus man pages
#
echo Configuring mdsplus man pages
if [ ! -r /usr/local/man ]; then
mkdir /usr/local/man
mkdir /usr/local/man/man1
mkdir /usr/local/man/man5
mkdir /usr/local/man/man8
chmod -R 755 /usr/local/man
else
if [ ! -r /usr/local/man/man1 ]; then
mkdir /usr/local/man/man1
chmod 755 /usr/local/man/man1
fi
if [ ! -r /usr/local/man/man5 ]; then
mkdir /usr/local/man/man5
chmod 755 /usr/local/man/man5
fi
if [ ! -r /usr/local/man/man8 ]; then
mkdir /usr/local/man/man8
chmod 755 /usr/local/man/man8
fi
fi
ln -sf $MDSPLUS_DIR/mdsplus/man/man1/*.gz /usr/local/man/man1
ln -sf $MDSPLUS_DIR/mdsplus/man/man5/*.gz /usr/local/man/man5
ln -sf $MDSPLUS_DIR/mdsplus/man/man8/*.gz /usr/local/man/man8
#
# Add mdsip to services
#
echo Adding mdsip MDSplus data server
if grep "^mdsip " /etc/services >/dev/null
then
        true
else
        echo "mdsip    8000/tcp # Added by package mdsplus" >> /etc/services
fi
#
# Add mdsipd to inetd.conf
#
/usr/openwin/bin/mkdirhier /var/log/mdsplus/mdsipd
if grep "^mdsip " /etc/inetd.conf > /dev/null
then
  true
else
  echo "mdsip stream	tcp	nowait root $MDSPLUS_DIR/mdsplus/bin/mdsipd mdsipd mdsip /var/log/mdsplus/mdsipd" >> /etc/inetd.conf
  kill -HUP `/bin/ps -e -o pid -o command | /bin/grep /usr/sbin/inetd | /bin/grep -v grep | /bin/awk '{print $1}'`
fi
echo Adding MDSplus login scripts
if grep "^. $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.sh" /etc/profile > /dev/null
then
  true
else
  echo ". $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.sh" >> /etc/profile
fi
if grep "^source $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.csh" /etc/.login > /dev/null
then
  true
else
  echo "source $MDSPLUS_DIR/mdsplus/etc/profile.d/mdsplus.csh" >> /etc/.login
fi
echo Creating sample /etc/mdsip.hosts file for mdsip server to user mapping
if [ ! -r /etc/mdsip.hosts ]; then 
  cp $MDSPLUS_DIR/mdsplus/etc/mdsip.hosts /etc/ 
fi
;;
esac
cp $MDSPLUS_DIR/mdsplus/rpm/post_uninstall_script $MDSPLUS_DIR/mdsplus/local/mdsplus_post_uninstall_script
